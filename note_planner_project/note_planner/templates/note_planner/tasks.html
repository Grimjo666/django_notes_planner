{% extends 'base.html' %}
{% load static %}
{% load my_filters %}

{% block js_scripts %}
<script src="{% static 'note_planner/js/add_task_form.js' %}"></script>
<script src="{% static 'note_planner/js/more-task-detailed-logic.js' %}"></script>
{% endblock %}

{% block title %}
<title>Задачи</title>
{% endblock %}

{% block css_style %}
<link rel="stylesheet" href="{% static 'note_planner/css/tasks.css' %}">
{% endblock %}

{% block sidebar %}
    {% include 'includes/sidebar.html' %}
{% endblock %}



{% block content %}
<h2>Задачи:</h2>
<div class="tasks-block">

    {% for task_name, value in tasks_dict.items%}
        <div class="checkbox-label">
            <div class="check-box-container">
                <input type="checkbox" id="task-checkbox-{{value|get:'id'}}" name="checkbox" value="{{ value.id }}" form="tasks-form">
            </div>

            {% if value|get:"priority" == 1 %}
            <div class="tasks-items" style="border-left-color: {{ high_priority }};">
            {% elif value|get:"priority" == 2 %}
            <div class="tasks-items" style="border-left-color: {{ medium_priority }};">
            {% else %}
            <div class="tasks-items" style="border-left-color: {{ low_priority }};">
            {% endif %}

                <h3>{{ task_name }}</h3>
                <p>
                    Дедлайн: {{ value|get:"due_date" }}
                    {% if value|get:"due_time" %}
                    - {{ value|get:"due_time" }}
                    {% endif %}
                </p>

                <form method="post" action="{% url 'done_task_page_path' value|get:'id' %}" >
                    {% csrf_token %}
                    <input type="hidden" name="form_type" value="done_edit_delete_task_form">
                    <button title="Выполнено" type="submit" class="button-done-task" name="button" value="done">✔</button>
                    <button title="Изменить" type="submit" class="button-edit-task" name="button" value="edit">✐</button>
                    <button title="Удалить" type="submit" class="button-delete-task" name="button" value="delete">✖</button>
                </form>
                <button type="button" class="button-show-description task-id-{{ value|get:'id' }}">▼</button>

            </div>

        </div>
        {% if value|get:"priority" == 1 %}
        <div class="more-detailed-task task-id-{{ value|get:'id' }} hidden" style="border-left-color: {{ high_priority }};">
        {% elif value|get:"priority" == 2 %}
        <div class="more-detailed-task task-id-{{ value|get:'id' }} hidden" style="border-left-color: {{ medium_priority }};">
        {% else %}
        <div class="more-detailed-task task-id-{{ value|get:'id' }} hidden" style="border-left-color: {{ low_priority }};">
        {% endif %}
            {% if value|get:"description" %}
            <h3 class="task-description-title">Описание задачи</h3>
            <div class="task-description-block">{{ value|get:"description" }}</div>
            {% endif %}
            <h3 class="task-subtask-title">Подзадачи:</h3>
            <div class="subtask-item"><button type="button" class="add-subtask-bottom task-id-{{ value|get:'id' }}">+</button></div>
            <div class="add-subtask-block task-id-{{ value|get:'id' }} hidden">
                <form method="POST" action="{% url 'tasks_page_path' %}">
                    {% csrf_token %}
                    {{ add_subtask_form.as_p }}
                    <input type="hidden" name="form_type" value="add_subtask">
                    <input type="hidden" name="task_id" value="{{ value|get:'id' }}">
                    <button type="submit" class="save-button task-id-{{ value|get:'id' }}">Сохранить</button>
                </form>
            </div>
            {% for subtask in value|get:"subtasks_list" %}

            <div class="subtask-item">
                <div class="subtask-title">
                    {% if subtask.completed %}
                    <h4 class="cross-out-text">{{ subtask.title }}</h4>
                    {% else %}
                    <h4>{{ subtask.title }}</h4>
                    {% endif %}
                    <div class="subtask-buttons">
                        <form method="post" action="">
                            {% csrf_token %}
                            <button title="Выполнено" type="submit" class="button-done-subtask">✔</button>
                        </form>
                        <button type="button" class="button-show-subtask-description subtask-id-{{ subtask|get:'id' }}">▼</button>
                        <form method="post" action="{% url 'delete_subtask_path' subtask|get:'id' %}">
                            {% csrf_token %}
                            <button type="submit" class="button-delete-subtask delete_button subtask-id-{{ subtask|get:'id' }}">✖</button>
                        </form>
                    </div>
                </div>

                <p class="subtask-description subtask-id-{{ subtask|get:'id' }} hidden">{{ subtask.description }}</p>
            </div>
            {% endfor %}
        </div>
    {% endfor %}
</div>

<div class="add-task-block hidden">
    <button type="submit" class="button-close-task-form">✖</button>
    <form method="POST" action="{% url 'tasks_page_path' %}">
        {% csrf_token %}
        {{ add_task_form.as_p }}
        <input type="hidden" name="form_type" value="add_task">
        <button type="submit" class="save-button">Сохранить</button>
    </form>
</div>

<div class="bottom-panel">
    <button title="Добавить" class="button-add-task">+</button>
    <form method="post" action="{% url 'tasks_page_path' %}" id="tasks-form">
        {% csrf_token %}
        <button title="В архив" class="button-archive-task" name="button" value="done">Выполнено</button>
        <button title="Удалить" class="button-delete-selected-tasks" name="button" value="delete">Удалить</button>
        <input type="hidden" name="form_type" value="checkbox_form">
    </form>
</div>

{% endblock %}
